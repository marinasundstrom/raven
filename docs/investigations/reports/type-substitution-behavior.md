# Type substitution parity with Roslyn

## Context
Roslyn treats constructed types and substituted members as first-class symbols: nested generic instantiations include inherited type arguments, `Arity` matches the generic definition, and display/metadata names stay stable regardless of how the symbol was produced. Raven’s constructed/substituted symbols should behave the same so `ToDisplayString`/`ToMetadataName` outputs remain consistent for type queries and generic method construction. The broader effort here is stabilizing the symbol model so source symbols and metadata (PE) symbols interoperate without diverging type identities or display/metadata names. A concrete milestone is compiling `samples/result.rav` against `Raven.Core.dll` (PE-only discriminated union `Result<T>`), using the commands in `samples/README.md` to prove source/metadata symbol equality and substitution are reliable across assemblies.

## Baseline
- Refreshed generated sources (syntax, bound nodes, diagnostics) before building.
- `dotnet build --property WarningLevel=0` currently fails while restoring/running `ravc` for `Raven.Core` (the generated Option/Result library), so no tests ran. The failure happens after the sample/fixture projects succeed, leaving the solution in a non-buildable state for this investigation.【678907†L1-L4】

## Findings
1. **Constructed types drop inherited type arguments.** `ConstructedNamedTypeSymbol` stores only the explicit type arguments passed to the current type in its `TypeArguments` array and derives `Arity` from that truncated list, so nested instantiations (e.g., `Outer<int>.Inner<string>`) report `Arity == 1` and `TypeArguments == [string]` even though the definition declares two type parameters.【F:src/Raven.CodeAnalysis/Symbols/Constructed/ConstructedNamedTypeSymbol.cs†L28-L29】【F:src/Raven.CodeAnalysis/Symbols/Constructed/ConstructedNamedTypeSymbol.cs†L343-L347】
2. **Display formatting falls back to type parameter names.** The symbol formatter renders generic arguments only when `TypeArguments.Length == TypeParameters.Length`. Because constructed nested types expose fewer `TypeArguments` than parameters, `ToDisplayString` emits open-generic parameter names instead of the substituted arguments, diverging from Roslyn’s closed-type displays.【F:src/Raven.CodeAnalysis/Symbols/SymbolExtensions.cs†L494-L511】
3. **Metadata identities inherit the wrong arity.** `ToFullyQualifiedMetadataName` appends ``N` using a symbol’s `Arity`. With `ConstructedNamedTypeSymbol.Arity` tied to the explicit argument count, nested constructed types produce metadata names like `Outer+Inner`1` instead of `Outer`1+Inner`1`, breaking lookups that expect Roslyn’s counting rules for nested generics.【F:src/Raven.CodeAnalysis/Symbols/ISymbol.cs†L376-L413】【F:src/Raven.CodeAnalysis/Symbols/Constructed/ConstructedNamedTypeSymbol.cs†L343-L347】
4. **Constructed methods keep the original container.** `ConstructedMethodSymbol` exposes its `ContainingSymbol/ContainingType` from the unconstructed definition, so static generic methods instantiated off substituted types still report the open container. This prevents Roslyn-style displays and type argument substitution on method identity/metadata queries.【F:src/Raven.CodeAnalysis/Symbols/Constructed/ConstructedMethodSymbol.cs†L51-L56】

## Plan
- [x] **Align constructed type shape with Roslyn.** Implemented definition-based `Arity` alongside inherited `TypeArguments`, ensuring nested instantiations expose the full argument list while still substituting local parameters through the constructed type.
- [x] **Keep display and metadata names closed.** Updated symbol formatting to slice the constructed type arguments for the current declaration and rely on definition arity, keeping `ToDisplayString` and `ToFullyQualifiedMetadataName` closed for nested generics.
- [x] **Tie constructed methods to their constructed containers.** When instantiating a `ConstructedMethodSymbol` for static or substituted generic methods, set `ContainingSymbol/ContainingType` to the constructed type so method displays and metadata identities inherit the closed container’s arity and arguments.
- [x] **Add regression tests.** Cover nested constructed types and constructed generic methods with assertions for `Arity`, `TypeParameters`, `TypeArguments`, `ToDisplayString`, and `ToFullyQualifiedMetadataName`, comparing against Roslyn’s expected outputs for both substituted members and constructed methods. Initial coverage now exercises nested constructed type argument closure and naming; extend to constructed methods next.
- [x] **Harden display/metadata regression coverage.** Added targeted unit tests for `ToDisplayString`, `ToString`, `DebuggerDisplay`, and `ToMetadataName` so constructed and substituted symbols keep Roslyn-parity across display and metadata identity surfaces, including metadata-backed constructed types and members.
- [x] **Close the PE/substitution gap for Raven.Core.** Verified that metadata-constructed discriminated unions compiled from `src/Raven.Core/Result.rav` preserve substituted constructors and parameter types when consumed from another compilation. Added regression coverage mirroring the `samples/result.rav` flow (per `samples/README.md`) so the Raven.Core PE build can satisfy the sample suite without reopening generic cases.
