/*
 * Demonstrates discriminated unions in Raven.
 */

import System.*

let res = parseNumber("42")

Console.WriteLine("Is error: ${res.IsError}")

let str = res match {
    .Ok(v) => "Number is: ${v}"
    .Error(message) => message
}

Console.WriteLine(str)

let res2 = parseNumber("foo").UnwrapOrThrow()

func parseNumber(str: string) -> Result<int> {
    return try int.Parse(str) match {
        int v => .Ok(v)
        Exception exc => .Error(exc.Message)
    }
}

union Result<T> {
    Ok(value: T)
    Error(message: string)
}

union Result<T, E> {
    Ok(value: T)
    Error(data: E)
}

extension ResultExtensions<T> for Result<T> {

    // Arrow prop syntax not supported
    //IsOk: bool => self is .Ok(value)

    // Compiles but IL isn't valid
    // Unhandled exception. System.TypeLoadException: Could not load type 'ResultExtensions`1' from assembly 'test-result, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null'.
    //IsError: bool {
    //    get => self is .Error(message)
    //}

    // Also fails
    // Unhandled exception. System.TypeLoadException: Could not load type 'ResultExtensions`1' from assembly 'test-result, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null'.
    IsError: bool {
        get {
            if self is .Error(error) {
                return true
            }
            return false;
        }
    }

    UnwrapOrDefault() -> T {
        if self is .Ok(value) {
            return value
        }
        return default(T)
    }

    UnwrapOrThrow() -> T {
        var error: string = ""
        if self is .Ok(value) {
            return value
        } else if self is .Error(error2) {
            error = error2
        }
        throw new System.InvalidOperationException("${error}")
    }
}